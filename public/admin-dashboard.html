<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SkillForge</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/portal.css">
    <style>
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--slate);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab.active {
            color: var(--gold);
            border-bottom-color: var(--gold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: var(--slate);
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 0.875rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .badge-suspended {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            margin: 0 0.25rem;
        }

        .upload-area {
            border: 2px dashed rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .search-box {
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            table {
                font-size: 0.85rem;
            }

            th,
            td {
                padding: 0.5rem;
            }

            .action-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">SkillForge Admin</a>
            <nav class="nav-links">
                <span id="adminName" class="text-gold"></span>
                <a href="#" id="logoutBtn">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container" style="padding: 2rem 20px;">
        <div class="card">
            <h1 class="text-gold mb-4">Admin Dashboard</h1>

            <div id="alertBox" class="alert"></div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="students">Students</button>
                <button class="tab" data-tab="handbooks">Handbooks</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="overview">
                <h2 class="mb-3">Analytics Overview</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3 id="totalStudents">-</h3>
                        <p>Total Students</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalHandbooks">-</h3>
                        <p>Total Handbooks</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="recentRegistrations">-</h3>
                        <p>New (30 days)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeStudents">-</h3>
                        <p>Active (7 days)</p>
                    </div>
                </div>

                <h3 class="mb-2">Students by Track</h3>
                <div id="trackStats"></div>
            </div>

            <!-- Students Tab -->
            <div class="tab-content" id="students">
                <h2 class="mb-3">Student Management</h2>

                <div class="filter-group">
                    <select id="trackFilter" class="form-control" style="max-width: 200px;">
                        <option value="">All Tracks</option>
                        <option value="Financial Markets">Financial Markets</option>
                        <option value="Web Development">Web Development</option>
                        <option value="Photography">Photography</option>
                    </select>

                    <select id="statusFilter" class="form-control" style="max-width: 200px;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                    </select>

                    <input type="text" id="searchStudent" class="form-control" placeholder="Search by name or email..."
                        style="max-width: 300px;">
                </div>

                <div style="overflow-x: auto;">
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Track</th>
                                <th>Status</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Handbooks Tab -->
            <div class="tab-content" id="handbooks">
                <h2 class="mb-3">Handbook Management</h2>

                <div class="upload-area">
                    <h3 class="mb-2">ðŸ“¤ Upload New Handbook</h3>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <input type="text" id="handbookTitle" class="form-control" placeholder="Handbook Title"
                                required>
                        </div>
                        <div class="form-group">
                            <textarea id="handbookDescription" class="form-control" placeholder="Description (optional)"
                                rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <select id="handbookTrack" class="form-control" required>
                                <option value="">Select Track</option>
                                <option value="Financial Markets">Financial Markets</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Photography">Photography</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="number" id="totalPages" class="form-control"
                                placeholder="Total Pages (optional)" min="1">
                        </div>
                        <div class="form-group">
                            <input type="file" id="handbookFile" accept=".pdf" required>
                        </div>
                        <button type="submit" class="btn btn-gold">Upload Handbook</button>
                    </form>
                </div>

                <h3 class="mb-2">Existing Handbooks</h3>
                <div style="overflow-x: auto;">
                    <table id="handbooksTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Track</th>
                                <th>Pages</th>
                                <th>Views</th>
                                <th>Uploaded</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="handbooksTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const adminToken = localStorage.getItem('adminToken');
        const admin = JSON.parse(localStorage.getItem('admin') || '{}');

        if (!adminToken) {
            window.location.href = '/admin-login.html';
        }

        const alertBox = document.getElementById('alertBox');

        function showAlert(message, type) {
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => alertBox.classList.remove('show'), 5000);
        }

        // Set admin info
        document.getElementById('adminName').textContent = admin.name || 'Admin';

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('adminToken');
            localStorage.removeItem('admin');
            window.location.href = '/admin-login.html';
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Load analytics
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/admin/analytics', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalStudents').textContent = data.data.totalStudents;
                    document.getElementById('totalHandbooks').textContent = data.data.totalHandbooks;
                    document.getElementById('recentRegistrations').textContent = data.data.recentRegistrations;
                    document.getElementById('activeStudents').textContent = data.data.activeStudents;

                    const trackStats = data.data.studentsByTrack.map(t =>
                        `<div class="stat-card"><h3>${t.count}</h3><p>${t._id}</p></div>`
                    ).join('');
                    document.getElementById('trackStats').innerHTML = `<div class="stats-grid">${trackStats}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load students
        async function loadStudents(track = '', status = '', search = '') {
            try {
                let url = '/api/admin/students?';
                if (track) url += `track=${track}&`;
                if (status) url += `status=${status}&`;
                if (search) url += `search=${search}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    renderStudents(data.data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(s => `
                <tr>
                    <td>${s.fullName}</td>
                    <td>${s.email}</td>
                    <td>${s.track}</td>
                    <td><span class="badge badge-${s.status}">${s.status}</span></td>
                    <td>${new Date(s.registrationDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline action-btn" onclick="toggleStatus('${s._id}', '${s.status}')">
                            ${s.status === 'active' ? 'Suspend' : 'Activate'}
                        </button>
                        <button class="btn btn-outline action-btn" style="border-color: #ef4444; color: #ef4444;" onclick="deleteStudent('${s._id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            try {
                const response = await fetch(`/api/admin/students/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Student status updated', 'success');
                    loadStudents();
                }
            } catch (error) {
                showAlert('Error updating status', 'error');
            }
        }

        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student?')) return;

            try {
                const response = await fetch(`/api/admin/students/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Student deleted', 'success');
                    loadStudents();
                    loadAnalytics();
                }
            } catch (error) {
                showAlert('Error deleting student', 'error');
            }
        }

        // Filters
        document.getElementById('trackFilter').addEventListener('change', (e) => {
            loadStudents(e.target.value, document.getElementById('statusFilter').value, document.getElementById('searchStudent').value);
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            loadStudents(document.getElementById('trackFilter').value, e.target.value, document.getElementById('searchStudent').value);
        });

        document.getElementById('searchStudent').addEventListener('input', (e) => {
            loadStudents(document.getElementById('trackFilter').value, document.getElementById('statusFilter').value, e.target.value);
        });

        // Load handbooks
        async function loadHandbooks() {
            try {
                const response = await fetch('/api/admin/handbooks', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    renderHandbooks(data.data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderHandbooks(handbooks) {
            const tbody = document.getElementById('handbooksTableBody');
            if (handbooks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No handbooks uploaded yet</td></tr>';
                return;
            }

            tbody.innerHTML = handbooks.map(h => `
                <tr>
                    <td>${h.title}</td>
                    <td>${h.track}</td>
                    <td>${h.totalPages || 'N/A'}</td>
                    <td>${h.viewCount}</td>
                    <td>${new Date(h.uploadDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline action-btn" style="border-color: #ef4444; color: #ef4444;" onclick="deleteHandbook('${h._id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteHandbook(id) {
            if (!confirm('Are you sure you want to delete this handbook?')) return;

            try {
                const response = await fetch(`/api/admin/handbooks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Handbook deleted', 'success');
                    loadHandbooks();
                    loadAnalytics();
                }
            } catch (error) {
                showAlert('Error deleting handbook', 'error');
            }
        }

        // Upload handbook
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('title', document.getElementById('handbookTitle').value);
            formData.append('description', document.getElementById('handbookDescription').value);
            formData.append('track', document.getElementById('handbookTrack').value);
            formData.append('totalPages', document.getElementById('totalPages').value || 0);
            formData.append('handbook', document.getElementById('handbookFile').files[0]);

            try {
                const response = await fetch('/api/admin/handbooks', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${adminToken}` },
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('Handbook uploaded successfully!', 'success');
                    document.getElementById('uploadForm').reset();
                    loadHandbooks();
                    loadAnalytics();
                } else {
                    showAlert(data.message || 'Upload failed', 'error');
                }
            } catch (error) {
                showAlert('Error uploading handbook', 'error');
            }
        });

        // Initialize
        loadAnalytics();
        loadStudents();
        loadHandbooks();
    </script>
</body>

</html>